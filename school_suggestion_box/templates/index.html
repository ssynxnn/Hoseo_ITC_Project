<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>í•™êµ ê±´ì˜í•¨ ğŸ“®</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- í—¤ë” -->
  <header class="bg-white shadow-sm p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold">ğŸ“® í•™êµ ê±´ì˜í•¨</h1>
    <div id="adminSection" class="flex items-center space-x-4">
      <div id="adminLogin" class="flex space-x-2">
        <input id="adminId" type="text" placeholder="ê´€ë¦¬ì ID" class="border px-2 py-1 rounded">
        <input id="adminPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="border px-2 py-1 rounded">
        <button onclick="adminLogin()" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">ë¡œê·¸ì¸</button>
      </div>
      <div id="adminLogout" class="hidden">
        <span class="text-sm text-gray-700">ê´€ë¦¬ì ëª¨ë“œ</span>
        <button onclick="adminLogout()" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </header>

  <!-- ì œì¶œ í¼ -->
  <section class="max-w-2xl mx-auto bg-white p-6 mt-6 rounded-xl shadow">
    <h2 class="text-xl font-semibold mb-4">âœï¸ ê±´ì˜ì‚¬í•­ ì‘ì„±</h2>
    <div class="space-y-3">
      <input id="studentName" type="text" placeholder="ì´ë¦„" class="w-full border rounded px-3 py-2">
      <input id="studentGrade" type="text" placeholder="í•™ë…„ / ë°˜" class="w-full border rounded px-3 py-2">
      <select id="category" class="w-full border rounded px-3 py-2">
        <option value="">-- ì¹´í…Œê³ ë¦¬ ì„ íƒ --</option>
        <option value="facility">ì‹œì„¤ ê°œì„ </option>
        <option value="restroom">í•™êµ í™”ì¥ì‹¤</option>
        <option value="food">ê¸‰ì‹ ê´€ë ¨</option>
        <option value="trash">ì“°ë ˆê¸° ë¬¸ì œ</option>
        <option value="academic">ìˆ˜ì—…/í•™ì‚¬</option>
        <option value="activity">ë™ì•„ë¦¬/í™œë™</option>
        <option value="environment">í•™êµ í™˜ê²½</option>
        <option value="safety">ì•ˆì „ ê´€ë ¨</option>
        <option value="library">ë„ì„œê´€</option>
        <option value="sports">ì²´ìœ¡/ìš´ë™</option>
        <option value="other">ê¸°íƒ€</option>
      </select>
      <input id="title" type="text" placeholder="ì œëª©" class="w-full border rounded px-3 py-2">
      <textarea id="content" rows="4" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”." class="w-full border rounded px-3 py-2"></textarea>
      <label class="flex items-center space-x-2">
        <input id="anonymous" type="checkbox" class="w-4 h-4">
        <span>ìµëª…ìœ¼ë¡œ ì œì¶œ</span>
      </label>
      <button onclick="submitSuggestion()" class="bg-green-500 text-white w-full py-2 rounded hover:bg-green-600">ì œì¶œí•˜ê¸°</button>
    </div>
  </section>

  <!-- í•„í„° -->
  <section class="max-w-6xl mx-auto mt-10 px-4">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold">ğŸ“‹ ê±´ì˜ì‚¬í•­ ëª©ë¡</h2>
      <div class="space-x-2">
        <select id="filterCategory" class="border px-2 py-1 rounded" onchange="loadSuggestions()">
          <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
          <option value="facility">ì‹œì„¤ ê°œì„ </option>
          <option value="restroom">í•™êµ í™”ì¥ì‹¤</option>
          <option value="food">ê¸‰ì‹ ê´€ë ¨</option>
          <option value="trash">ì“°ë ˆê¸° ë¬¸ì œ</option>
          <option value="academic">ìˆ˜ì—…/í•™ì‚¬</option>
          <option value="activity">ë™ì•„ë¦¬/í™œë™</option>
          <option value="environment">í•™êµ í™˜ê²½</option>
          <option value="safety">ì•ˆì „ ê´€ë ¨</option>
          <option value="library">ë„ì„œê´€</option>
          <option value="sports">ì²´ìœ¡/ìš´ë™</option>
          <option value="other">ê¸°íƒ€</option>
        </select>
        <select id="filterStatus" class="border px-2 py-1 rounded" onchange="loadSuggestions()">
          <option value="">ì „ì²´ ìƒíƒœ</option>
          <option value="pending">ê²€í† ì¤‘</option>
          <option value="in-progress">ì²˜ë¦¬ì¤‘</option>
          <option value="completed">ì™„ë£Œ</option>
        </select>
      </div>
    </div>
    <div id="suggestionList" class="grid gap-4 md:grid-cols-2"></div>
  </section>

  <script>
    async function submitSuggestion() {
      const data = {
        studentName: document.getElementById('studentName').value,
        studentGrade: document.getElementById('studentGrade').value,
        category: document.getElementById('category').value,
        title: document.getElementById('title').value,
        content: document.getElementById('content').value,
        anonymous: document.getElementById('anonymous').checked
      };
      if (!data.title || !data.content || !data.category) {
        alert('ì œëª©, ë‚´ìš©, ì¹´í…Œê³ ë¦¬ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }
      const res = await axios.post('/submit_suggestion', data);
      if (res.data.success) {
        alert('ê±´ì˜ì‚¬í•­ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.');
        document.querySelectorAll('input, textarea').forEach(i => i.value = '');
        document.getElementById('anonymous').checked = false;
        loadSuggestions();
      }
    }

    async function loadSuggestions() {
      const category = document.getElementById('filterCategory').value;
      const status = document.getElementById('filterStatus').value;
      const res = await axios.get('/get_suggestions', { params: { category, status } });
      const list = document.getElementById('suggestionList');
      list.innerHTML = '';

      res.data.forEach(s => {
        const div = document.createElement('div');
        div.className = 'bg-white p-4 rounded-xl shadow relative';
        div.innerHTML = `
          <h3 class="text-lg font-semibold mb-1">${s.title}</h3>
          <p class="text-sm text-gray-600 mb-2">${s.content}</p>
          <p class="text-xs text-gray-500">${s.studentName} ${s.studentGrade}</p>
          <span class="text-xs inline-block mt-2 px-2 py-1 rounded bg-yellow-100 text-yellow-800">${s.status}</span>
          ${s.adminResponse ? `<div class="mt-3 border-t pt-2 text-sm"><strong>ê´€ë¦¬ì ë‹µë³€:</strong> ${s.adminResponse}</div>` : ''}
          ${isAdmin ? `
            <div class="mt-2 border-t pt-2 space-y-2">
              <textarea id="response-${s.id}" class="border w-full rounded px-2 py-1" placeholder="ë‹µë³€ ì‘ì„±...">${s.adminResponse || ''}</textarea>
              <select id="status-${s.id}" class="border rounded px-2 py-1 w-full">
                <option value="pending" ${s.status === 'pending' ? 'selected' : ''}>ê²€í† ì¤‘</option>
                <option value="in-progress" ${s.status === 'in-progress' ? 'selected' : ''}>ì²˜ë¦¬ì¤‘</option>
                <option value="completed" ${s.status === 'completed' ? 'selected' : ''}>ì™„ë£Œ</option>
              </select>
              <button onclick="updateSuggestion(${s.id})" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 w-full">ì €ì¥</button>
              <button onclick="deleteSuggestion(${s.id})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 w-full">ì‚­ì œ</button>
            </div>` : ''}
        `;
        list.appendChild(div);
      });
    }

    async function updateSuggestion(id) {
      const response = document.getElementById(`response-${id}`).value;
      const status = document.getElementById(`status-${id}`).value;
      const res = await axios.post('/admin_response', { suggestionId: id, response, status });
      if (res.data.success) {
        alert('ì—…ë°ì´íŠ¸ ì™„ë£Œ!');
        loadSuggestions();
      }
    }

    async function deleteSuggestion(id) {
      if (!confirm('ì •ë§ ì´ ê±´ì˜ì‚¬í•­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      const res = await axios.post('/delete_suggestion', { suggestionId: id });
      if (res.data.success) {
        alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadSuggestions();
      } else {
        alert(res.data.message);
      }
    }

    async function adminLogin() {
      const adminId = document.getElementById('adminId').value;
      const password = document.getElementById('adminPw').value;
      const res = await axios.post('/admin_login', { adminId, password });
      if (res.data.success) {
        alert('ê´€ë¦¬ì ë¡œê·¸ì¸ ì„±ê³µ!');
        isAdmin = true;
        document.getElementById('adminLogin').classList.add('hidden');
        document.getElementById('adminLogout').classList.remove('hidden');
        loadSuggestions();
      } else {
        alert(res.data.message);
      }
    }

    async function adminLogout() {
      await axios.post('/admin_logout');
      isAdmin = false;
      document.getElementById('adminLogin').classList.remove('hidden');
      document.getElementById('adminLogout').classList.add('hidden');
      loadSuggestions();
    }

    let isAdmin = false;
    loadSuggestions();
  </script>

</body>
</html>